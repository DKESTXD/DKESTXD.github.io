

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.jpg">
  <link rel="icon" href="/img/fluid.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Li Fengke">
  <meta name="keywords" content="">
  
    <meta name="description" content="​	刷b站时刷到了一个up用魔杖做智能家具的视频，正好要做嵌高暑假作业了，来尝试实现一下吧">
<meta property="og:type" content="article">
<meta property="og:title" content="做一根“魔杖”——记2025嵌高项目">
<meta property="og:url" content="https://dkestxd.github.io/2025/12/02/%E5%81%9A%E4%B8%80%E6%A0%B9%E2%80%9C%E9%AD%94%E6%9D%96%E2%80%9D%E2%80%94%E2%80%94%E8%AE%B02025%E5%B5%8C%E9%AB%98%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="DKEST">
<meta property="og:description" content="​	刷b站时刷到了一个up用魔杖做智能家具的视频，正好要做嵌高暑假作业了，来尝试实现一下吧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/ScreenShot_2025-12-02_101641_001.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901110900_29.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/ScreenShot_2025-12-02_101356_007.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/stitching-collage-1764643307827.jpg">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/stitching-collage-1764643543204.jpg">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/ScreenShot_2025-12-02_105353_677.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901111919_86.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/stitching-collage-1764643940118.jpg">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901111002_32.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901111006_33.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/stitching-collage-1764644244461.jpg">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112242_92.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112244_93.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112340_95.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112401_96.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112404_97.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112453_102.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112650_111.png">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/stitching-collage-1764644572720.jpg">
<meta property="og:image" content="https://dkestxd.github.io/img/mozhang_img/ScreenShot_2025-12-02_110409_690.png">
<meta property="article:published_time" content="2025-12-01T16:00:00.000Z">
<meta property="article:modified_time" content="2025-12-02T05:11:53.378Z">
<meta property="article:author" content="Li Fengke">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://dkestxd.github.io/img/mozhang_img/ScreenShot_2025-12-02_101641_001.png">
  
  
  
  <title>做一根“魔杖”——记2025嵌高项目 - DKEST</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"dkestxd.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>DKEST</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="做一根“魔杖”——记2025嵌高项目"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-02 00:00" pubdate>
          2025年12月2日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          59 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">做一根“魔杖”——记2025嵌高项目</h1>
            
            
              <div class="markdown-body">
                
                <p>​	刷b站时刷到了一个up用魔杖做智能家具的视频，正好要做嵌高暑假作业了，来尝试实现一下吧</p>
<span id="more"></span>

<h1 id="一、思路"><a href="#一、思路" class="headerlink" title="一、思路"></a>一、思路</h1><p>​	开发板均选择<strong>esp32 devkit v1</strong>，传感器选择<strong>MPU6050</strong>，小车驱动选择<strong>TB6612</strong></p>
<p>​	魔杖部分：利用MPU6050可以监测加速度和角速度的功能，获得世界坐标系下的去除重力加速度分量后的三轴加速度，要求得到的结果准确、低噪、响应速度快，然后将加速度二次积分得到三轴位移，便可以表示出世界坐标系下的三轴轨迹，再对这些轨迹按照机器学习的方法进行训练，获得能够分类轨迹的模型，再把模型部署到开发板上去，这样便能够实现对分类结果的实时运算，再将这个结果通过蓝牙传输给小车端的板子，对其控制。</p>
<p>​	小车部分：用TB6612写出基本的控制运动的代码，接收从魔杖端发送过来的指令并对其做出响应。</p>
<p>​	预计实现四种轨迹（上下左右）的控制指令</p>
<h1 id="二、-魔杖part"><a href="#二、-魔杖part" class="headerlink" title="二、 魔杖part"></a>二、 魔杖part</h1><h2 id="2-1-硬件连接"><a href="#2-1-硬件连接" class="headerlink" title="2.1 硬件连接"></a>2.1 硬件连接</h2><p>​	魔杖部分共用到的硬件有：esp32 devkit v1开发板，MPU6050传感器，按钮，5V锂电池，microusb公对母带开关导线，若干杜邦线。</p>
<p>​	其中MPU6050为I2C通信，有串行数据线SDA，串行时钟线SCL，均为开漏输出(OD)，而esp32仅有两个管脚支持I2C通信，依次为   D21——SDA、D22——SCL，剩下两个端口分别接3.3V和GND，来给传感器供电。</p>
<p>​	双端按钮默认常断，一端接地，一端接D13，因为D13有内置上拉电阻，否则平时浮空输入时改管脚电平不定。而电池通过microusb公对母导线与esp32连接来给开发板供电，这条导线上的按钮即为整个魔杖的上电开关。</p>
<p><img src="/img/mozhang_img/ScreenShot_2025-12-02_101641_001.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="2-2-三轴加速度的获取"><a href="#2-2-三轴加速度的获取" class="headerlink" title="2.2 三轴加速度的获取"></a>2.2 三轴加速度的获取</h2><p>​	我们想要把传感器的运动轨迹解算出来，即将传感器的运动轨迹用位移的数组表示出了，首先要从加速度的获取入手，获得世界坐标系下的三轴加速度再经过两次积分后便可以得到位移数组。</p>
<h3 id="2-2-1-DMP库直接获取"><a href="#2-2-1-DMP库直接获取" class="headerlink" title="2.2.1 DMP库直接获取"></a>2.2.1 DMP库直接获取</h3><p>​	因为我们所用的是MPU6050传感器，因此我们自然会想到用其自带的DMP姿态解算库，其内置的若干函数可以直接计算出世界坐标系下去除重力分量的三轴加速度。</p>
<p>​	核心代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;I2Cdev.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;MPU6050_6Axis_MotionApps20.h&quot;</span></span><br>MPU6050 mpu;<br><span class="hljs-type">uint8_t</span> fifoBuffer[<span class="hljs-number">64</span>];<span class="hljs-comment">//内部缓存</span><br>Quaternion q;<span class="hljs-comment">//四元数</span><br>VectorFloat gravity;<span class="hljs-comment">//重力分量</span><br>VectorInt16 acc_raw;<span class="hljs-comment">//三轴原始加速度</span><br>VectorInt16 lineacc;<span class="hljs-comment">//去除重力的线性加速度</span><br>VectorInt16 worldacc;<span class="hljs-comment">//世界坐标系下的</span><br><span class="hljs-type">float</span> ypr[<span class="hljs-number">3</span>];<span class="hljs-comment">//三轴角</span><br><span class="hljs-type">float</span> acc[<span class="hljs-number">3</span>];<span class="hljs-comment">//最终加速度</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span><br>&#123;<br>  Wire.begin();<br>  Wire.setClock(<span class="hljs-number">400000</span>);<span class="hljs-comment">//I2C通信速率</span><br>  Serial.begin(<span class="hljs-number">115200</span>);<span class="hljs-comment">//波特率</span><br>  mpu.initialize();<br>  mpu.dmpInitialize();<br>  mpu.CalibrateAccel(<span class="hljs-number">6</span>);<br>  mpu.CalibrateGyro(<span class="hljs-number">6</span>);<br>  mpu.PrintActiveOffsets();<br>  mpu.setDMPEnabled(<span class="hljs-literal">true</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (mpu.dmpGetCurrentFIFOPacket(fifoBuffer))<span class="hljs-comment">//读缓存</span><br>  &#123;<br>    mpu.dmpGetQuaternion(&amp;q,fifoBuffer);<span class="hljs-comment">//读四元数</span><br>    mpu.dmpGetGravity(&amp;gravity,&amp;q);<span class="hljs-comment">//读重力分量</span><br>    mpu.dmpGetAccel(&amp;acc_raw,fifoBuffer);<span class="hljs-comment">//读原始加速度</span><br>    acc_raw.x=acc_raw.x/<span class="hljs-number">2</span>;<br>    acc_raw.y=acc_raw.y/<span class="hljs-number">2</span>;<br>    acc_raw.z=acc_raw.z/<span class="hljs-number">2</span>;<br>    mpu.dmpGetLinearAccel(&amp;lineacc,&amp;acc_raw,&amp;gravity);<span class="hljs-comment">//去除重力</span><br>    mpu.dmpGetYawPitchRoll(ypr,&amp;q,&amp;gravity);<br>    mpu.dmpConvertToWorldFrame(&amp;worldacc,&amp;lineacc,&amp;q);<span class="hljs-comment">//转世界坐标系</span><br>    acc[<span class="hljs-number">0</span>]=worldacc.x/<span class="hljs-number">8192.0f</span>;<span class="hljs-comment">//归一化</span><br>    acc[<span class="hljs-number">1</span>]=worldacc.y/<span class="hljs-number">8192.0f</span>;<br>    acc[<span class="hljs-number">2</span>]=worldacc.z/<span class="hljs-number">8192.0f</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​	中间有一段是将原始加速度除以二，是因为在其原始函数中，去除重力分量的定义是这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint8_t</span> <span class="hljs-title function_">MPU6050_6Axis_MotionApps20::dmpGetLinearAccel</span><span class="hljs-params">(VectorInt16 *v, VectorInt16 *vRaw, VectorFloat *gravity)</span> &#123;<br>    <span class="hljs-comment">// get rid of the gravity component (+1g = +8192 in standard DMP FIFO packet, sensitivity is 2g)</span><br>    v -&gt; x = vRaw -&gt; x - gravity -&gt; x*<span class="hljs-number">8192</span>;<br>    v -&gt; y = vRaw -&gt; y - gravity -&gt; y*<span class="hljs-number">8192</span>;<br>    v -&gt; z = vRaw -&gt; z - gravity -&gt; z*<span class="hljs-number">8192</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​	所有加速度得到的初始值单位是LSB，也就是数模转换的灵敏度，这个取决于量程范围：对±2g，灵敏度为16384 LSB&#x2F;g；对±4g，灵敏度为8192 LSB&#x2F;g。但是上述函数的原理，是将重力分量乘8192再减的，但是默认量程为2g，这就导致了灵敏度换算出现差异，于是原始灵敏度要先除以二再进行运算。</p>
<p>​	但是我们最终得到的数据存在相当大的问题：z轴有非常严重的零点漂移，而且随着传感器姿态不同，漂移量也随之变化，最大可达0.3g，这就导致了我们不能仅用添加一个偏置项的方法来消除零漂。而z轴又是非常重要的，关系到上下轨迹的判断，假如静止时偏移量为向上的0.3g，而实际运动的加速度向下且小于0.3g，此时记录下来的加速度变化数据方向全部向上，会将原本向下的轨迹误判为向上。</p>
<p>​	简单判断原因可能与其内部运算逻辑有关系，重力分量是四元数运算得到的，三轴加速度是从缓存中读出来的，这差异可能就导致了结果有出入。因为DMP库是内部封装的，所以我们只能换其他算法。</p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901110900_29.png" srcset="/img/loading.gif" lazyload></p>
<center>零点漂移量较小时的三轴加速度</center>

<h3 id="2-2-2-加速度角速度-欧拉角-旋转矩阵算法"><a href="#2-2-2-加速度角速度-欧拉角-旋转矩阵算法" class="headerlink" title="2.2.2 加速度角速度-欧拉角-旋转矩阵算法"></a>2.2.2 加速度角速度-欧拉角-旋转矩阵算法</h3><p>​	于是我们脱离DMP库，按照一定的顺序逐步计算出来世界坐标系下的三轴加速度。</p>
<h4 id="2-2-2-1-Adafruit库"><a href="#2-2-2-1-Adafruit库" class="headerlink" title="2.2.2.1 Adafruit库"></a>2.2.2.1 Adafruit库</h4><p>​	Adafruit库可以直接从传感器中读出三轴加速度和三轴角速度数据，而且值准确、低噪、响应快。为方便我们定义了一个头文件。</p>
<p>mpu6050.h </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Adafruit_MPU6050.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Adafruit_Sensor.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Wire.h&gt;</span></span><br>Adafruit_MPU6050 mpu;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MPU6050_DATA</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">float</span> Acc_X = <span class="hljs-number">0.0</span>;<span class="hljs-comment">//三轴加速度m/s^2</span><br>  <span class="hljs-type">float</span> Acc_Y = <span class="hljs-number">0.0</span>;<br>  <span class="hljs-type">float</span> Acc_Z = <span class="hljs-number">0.0</span>;<br>  <span class="hljs-type">float</span> Angle_Velocity_R = <span class="hljs-number">0.0</span>; <span class="hljs-comment">//三轴角速度rad/s</span><br>  <span class="hljs-type">float</span> Angle_Velocity_P = <span class="hljs-number">0.0</span>;<br>  <span class="hljs-type">float</span> Angle_Velocity_Y = <span class="hljs-number">0.0</span>;<br>&#125;mpu6050_data;<br><span class="hljs-type">void</span> <span class="hljs-title function_">Init_mpu6050</span><span class="hljs-params">()</span>&#123;<br>    	...<span class="hljs-comment">//主要包含一些量程等初始量设置</span><br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">ReadMPU6050</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">sensors_event_t</span> a, g, temp;<br>  mpu.getEvent(&amp;a, &amp;g, &amp;temp);<br>  mpu6050_data.Acc_X = a.acceleration.x;<br>  mpu6050_data.Acc_Y = a.acceleration.y;<br>  mpu6050_data.Acc_Z = a.acceleration.z;<br>  mpu6050_data.Angle_Velocity_R = g.gyro.x; <br>  mpu6050_data.Angle_Velocity_P = g.gyro.y; <br>  mpu6050_data.Angle_Velocity_Y = g.gyro.z; <br>&#125;<br></code></pre></td></tr></table></figure>

<p>mozhang.ino（其中mpu6050_data是全局变量）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mpu6050.h&quot;</span></span><br>...<br><span class="hljs-type">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> &#123;<br> Init_mpu6050();<br> ...<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>ReadMPU6050()；<br>...<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-2-Madgwick算法"><a href="#2-2-2-2-Madgwick算法" class="headerlink" title="2.2.2.2 Madgwick算法"></a>2.2.2.2 Madgwick算法</h4><p>​	通过Adafruit库我们获得了传感器坐标系下的三轴加速度和角速度，为转到世界坐标系我们需要由欧拉角得到的旋转矩阵，于是问题就变成了如何用获得的这六个值来解出来三个欧拉角。我们采用Madgwick算法。</p>
<p>​	Madgwick算法是一种基于四元数的六轴融合的姿态滤波算法，大致原理如下图：</p>
<p><img src="/img/mozhang_img/ScreenShot_2025-12-02_101356_007.png" srcset="/img/loading.gif" lazyload></p>
<p>​	但是这个算法太难了，设计的变量于公式推导都比较多，因此我们直接搬运了<a target="_blank" rel="noopener" href="https://github.com/kriswiner/MPU6050">https://github.com/kriswiner/MPU6050</a><br>这个项目的算法函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">MadgwickQuaternionUpdate</span><span class="hljs-params">(<span class="hljs-type">float</span> ax, <span class="hljs-type">float</span> ay, <span class="hljs-type">float</span> az, <span class="hljs-type">float</span> gyrox, <span class="hljs-type">float</span> gyroy, <span class="hljs-type">float</span> gyroz)</span><br>&#123;<br>    <span class="hljs-type">float</span> q1 = q[<span class="hljs-number">0</span>], q2 = q[<span class="hljs-number">1</span>], q3 = q[<span class="hljs-number">2</span>], q4 = q[<span class="hljs-number">3</span>];         <span class="hljs-comment">// short name local variable for readability</span><br>    <span class="hljs-type">float</span> norm;                                               <span class="hljs-comment">// vector norm</span><br>    <span class="hljs-type">float</span> f1, f2, f3;                                         <span class="hljs-comment">// objetive funcyion elements</span><br>    <span class="hljs-type">float</span> J_11or24, J_12or23, J_13or22, J_14or21, J_32, J_33; <span class="hljs-comment">// objective function Jacobian elements</span><br>    <span class="hljs-type">float</span> qDot1, qDot2, qDot3, qDot4;<br>    <span class="hljs-type">float</span> hatDot1, hatDot2, hatDot3, hatDot4;<br>    <span class="hljs-type">float</span> gerrx, gerry, gerrz, gbiasx, gbiasy, gbiasz;        <span class="hljs-comment">// gyro bias error</span><br><br>    <span class="hljs-comment">// Auxiliary variables to avoid repeated arithmetic</span><br>    <span class="hljs-type">float</span> _halfq1 = <span class="hljs-number">0.5f</span> * q1;<br>    <span class="hljs-type">float</span> _halfq2 = <span class="hljs-number">0.5f</span> * q2;<br>    <span class="hljs-type">float</span> _halfq3 = <span class="hljs-number">0.5f</span> * q3;<br>    <span class="hljs-type">float</span> _halfq4 = <span class="hljs-number">0.5f</span> * q4;<br>    <span class="hljs-type">float</span> _2q1 = <span class="hljs-number">2.0f</span> * q1;<br>    <span class="hljs-type">float</span> _2q2 = <span class="hljs-number">2.0f</span> * q2;<br>    <span class="hljs-type">float</span> _2q3 = <span class="hljs-number">2.0f</span> * q3;<br>    <span class="hljs-type">float</span> _2q4 = <span class="hljs-number">2.0f</span> * q4;<br>    <span class="hljs-type">float</span> _2q1q3 = <span class="hljs-number">2.0f</span> * q1 * q3;<br>    <span class="hljs-type">float</span> _2q3q4 = <span class="hljs-number">2.0f</span> * q3 * q4;<br><br>    <span class="hljs-comment">// Normalise accelerometer measurement</span><br>    norm = <span class="hljs-built_in">sqrt</span>(ax * ax + ay * ay + az * az);<br>    <span class="hljs-keyword">if</span> (norm == <span class="hljs-number">0.0f</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// handle NaN</span><br>    norm = <span class="hljs-number">1.0f</span>/norm;<br>    ax *= norm;<br>    ay *= norm;<br>    az *= norm;<br>	...    <br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">yaw=<span class="hljs-built_in">atan2</span>(<span class="hljs-number">2.0f</span> * (q[<span class="hljs-number">1</span>] * q[<span class="hljs-number">2</span>] + q[<span class="hljs-number">0</span>] * q[<span class="hljs-number">3</span>]), q[<span class="hljs-number">0</span>] * q[<span class="hljs-number">0</span>] + q[<span class="hljs-number">1</span>] * q[<span class="hljs-number">1</span>] - q[<span class="hljs-number">2</span>] * q[<span class="hljs-number">2</span>] - q[<span class="hljs-number">3</span>] * q[<span class="hljs-number">3</span>]);   <br>pitch=-<span class="hljs-built_in">asin</span>(<span class="hljs-number">2.0f</span> * (q[<span class="hljs-number">1</span>] * q[<span class="hljs-number">3</span>] - q[<span class="hljs-number">0</span>] * q[<span class="hljs-number">2</span>]));<br>roll=<span class="hljs-built_in">atan2</span>(<span class="hljs-number">2.0f</span> * (q[<span class="hljs-number">0</span>] * q[<span class="hljs-number">1</span>] + q[<span class="hljs-number">2</span>] * q[<span class="hljs-number">3</span>]), q[<span class="hljs-number">0</span>] * q[<span class="hljs-number">0</span>] - q[<span class="hljs-number">1</span>] * q[<span class="hljs-number">1</span>] - q[<span class="hljs-number">2</span>] * q[<span class="hljs-number">2</span>] + q[<span class="hljs-number">3</span>] * q[<span class="hljs-number">3</span>]);<br></code></pre></td></tr></table></figure>

<p>​	最终通过这个算法我们得到准确且响应快的欧拉角，但是仍然存在yaw角随时间慢慢偏移的现象，这个是不可避免的，这个需要加装磁力计来校正，而MPU6050没有磁力计。</p>
<h4 id="2-2-2-3-旋转矩阵"><a href="#2-2-2-3-旋转矩阵" class="headerlink" title="2.2.2.3 旋转矩阵"></a>2.2.2.3 旋转矩阵</h4><p>​	用获得的欧拉角求出旋转矩阵，便可以从传感器坐标系转为世界坐标系，再减去重力分量便可以得到我们需要的世界坐标系下去除重力分量的三轴加速度。</p>
<p>  $$ WorldAcc_{(3×1)}&#x3D;R · Acc_{(3×1)}$$</p>
<p>旋转矩阵定义为：</p>
<p>​                                                               <img src="/img/mozhang_img/stitching-collage-1764643307827.jpg" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">float</span> R[<span class="hljs-number">3</span>][<span class="hljs-number">3</span>];<br>R[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-built_in">cos</span>(pitch)*<span class="hljs-built_in">cos</span>(yaw);<br>R[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]=<span class="hljs-built_in">cos</span>(yaw)*<span class="hljs-built_in">sin</span>(roll)*<span class="hljs-built_in">sin</span>(pitch)-<span class="hljs-built_in">cos</span>(roll)*<span class="hljs-built_in">sin</span>(yaw);<br>R[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>]=<span class="hljs-built_in">sin</span>(roll)*<span class="hljs-built_in">sin</span>(yaw)+<span class="hljs-built_in">cos</span>(roll)*<span class="hljs-built_in">cos</span>(yaw)*<span class="hljs-built_in">sin</span>(pitch);<br><br>R[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]=<span class="hljs-built_in">cos</span>(pitch)*<span class="hljs-built_in">sin</span>(yaw);<br>R[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]=<span class="hljs-built_in">cos</span>(roll)*<span class="hljs-built_in">cos</span>(yaw)+<span class="hljs-built_in">sin</span>(roll)*<span class="hljs-built_in">sin</span>(pitch)*<span class="hljs-built_in">sin</span>(yaw);<br>R[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>]=<span class="hljs-built_in">cos</span>(roll)*<span class="hljs-built_in">sin</span>(pitch)*<span class="hljs-built_in">sin</span>(yaw)-<span class="hljs-built_in">cos</span>(yaw)*<span class="hljs-built_in">sin</span>(roll);<br><br>R[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]=-<span class="hljs-built_in">sin</span>(pitch);<br>R[<span class="hljs-number">2</span>][<span class="hljs-number">1</span>]=<span class="hljs-built_in">cos</span>(pitch)*<span class="hljs-built_in">sin</span>(roll);<br>R[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>]=<span class="hljs-built_in">cos</span>(roll)*<span class="hljs-built_in">cos</span>(pitch);<br><br>worldAccX=R[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]*mpu6050_data.Acc_X+R[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]*mpu6050_data.Acc_Y+R[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>]*mpu6050_data.Acc_Z;<br>worldAccY=R[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]*mpu6050_data.Acc_X+R[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]*mpu6050_data.Acc_Y+R[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>]*mpu6050_data.Acc_Z;<br>worldAccZ=R[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]*mpu6050_data.Acc_X+R[<span class="hljs-number">2</span>][<span class="hljs-number">1</span>]*mpu6050_data.Acc_Y+R[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>]*mpu6050_data.Acc_Z;<br>worldAccZ-=<span class="hljs-number">9.8065</span>;<br></code></pre></td></tr></table></figure>

<p>以下为部分动作时的加速度响应情况：</p>
<p><img src="/img/mozhang_img/stitching-collage-1764643543204.jpg" srcset="/img/loading.gif" lazyload alt="上、下、左、右"></p>
<h2 id="2-3-世界坐标系的定义"><a href="#2-3-世界坐标系的定义" class="headerlink" title="2.3 世界坐标系的定义"></a>2.3 世界坐标系的定义</h2><p>​	前面的一切工作都是为了获得世界坐标系下的加速度，但是世界坐标系到底是怎么定义的，直接关系到了我们对姿态的解算。</p>
<p>​	传感器坐标系的定义与传感器姿态有关，xy轴是相对于传感器确定的，z轴也因此确定下来。而定义的世界坐标系与上电时刻的传感器坐标系有关但是并不完全重合。这在之前可以看出：去除重力加速度分量时仅仅在z轴减去g便可以得到非常稳定的结果，这给我们启发，定义的<strong>世界坐标系的z轴是始终与重力方向相反竖直向上的</strong>，z轴便确定了，而其<strong>xy轴则是上电时刻传感器坐标系的xy轴在垂直于z轴的水平面上的投影</strong>。</p>
<p>​	这样不同的上电姿态只会影响xy轴的方向，但是这也是亟待解决的，因为关系到左右轨迹的确定，如果xy轴不确定，那么左右移动时其在xy轴上的分量也是不确定的。</p>
<p>​	再者，我们所需要的轨迹，本质上都是二维轨迹，换句话说就是我们只需要用到三维轨迹在某个固定的二维平面上的投影即可。于是我们想到可以<strong>令传感器的y轴与魔杖共线，这样xOz平面始终垂直于魔杖</strong>，这样就实现了正常手持魔杖时无论传感器以什么姿态上电，其左右运动对应的都是x的变化。而我们用来分类的轨迹用xOz平面上的投影即可，因为xz轴都是相对于魔杖固定的。</p>
<p>​	只要挥舞时人的朝向与上电时保存一致，后续训练的模型就是可用的。</p>
<p><img src="/img/mozhang_img/ScreenShot_2025-12-02_105353_677.png" srcset="/img/loading.gif" lazyload alt="传感器坐标系"></p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901111919_86.png" srcset="/img/loading.gif" lazyload alt="传感器安装方法"></p>
<p>​	按照这种方式安装传感器最终得到的效果如下：</p>
<p><img src="/img/mozhang_img/stitching-collage-1764643940118.jpg" srcset="/img/loading.gif" lazyload alt="左、右、上、下"></p>
<h2 id="2-4-数据采集逻辑以及积分环节"><a href="#2-4-数据采集逻辑以及积分环节" class="headerlink" title="2.4 数据采集逻辑以及积分环节"></a>2.4 数据采集逻辑以及积分环节</h2><p>​	现在我们可以获得效果非常好的数据，但是我们不能一直获取数据并运算，于是需要做一个“防误触”机制，即设置数据采集和运算的开始标志，最容易想到的便是按钮，按下开始采集，松开停止采集并且将采集到的数据进行运算。此外也可以设置一个阈值，当加速度到达某个阈值时才开始采集，但是后者不太稳定，而且阈值也不好设置，遂采用前者。</p>
<h3 id="2-4-1-按键触发数据采集"><a href="#2-4-1-按键触发数据采集" class="headerlink" title="2.4.1 按键触发数据采集"></a>2.4.1 按键触发数据采集</h3><p>​	直观点要实现按下按钮开始收集数据，松开按钮或者按下时间达到2s后停止记录数据，并且执行数据的一系列计算，然后再按下开启新的一段采集流程。</p>
<p>基本逻辑为：</p>
<ol>
<li>定义三个数组为三轴，按下按钮开始记录，每次循环中将本次数据记录到数组中；在首次按下按钮时初始化一系列变量：包括下标，时间，flag2(开始计时标志)，偏置项</li>
<li>松开按钮或者时间计时为2s后停止记录并进行积分运算得到轨迹。同时更新flag1，flag2关闭记录通道和积分运算通道。</li>
</ol>
<p>​	其中为了解决当计时2s已到但是按钮未松开导致一直在记录使数组溢出，定义flag1作为进入记录的标志；其中当按钮为松开状态时flag1为0，即只有按钮松开后才能够再次按下开始记录</p>
<p>​	为了避免平时即使没有记录也进入到积分环节，定义flag2，开始计时时才开始，积分结束后再关闭。	</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">int</span> buttonPin=<span class="hljs-number">13</span>;<span class="hljs-comment">//按钮GPIO13</span><br><span class="hljs-type">int</span> buttonstate=<span class="hljs-number">0</span>;<span class="hljs-comment">//按钮状态</span><br><span class="hljs-type">int</span> lastbuttonstate=<span class="hljs-number">0</span>;<span class="hljs-comment">//上一次按钮状态</span><br><span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<span class="hljs-comment">//下标</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> starttime=<span class="hljs-number">0</span>;<span class="hljs-comment">//开始时间</span><br><span class="hljs-type">int</span> flag1=<span class="hljs-number">0</span>;<span class="hljs-comment">//为了标志2s已到但是按钮未松开的情况的flag</span><br><span class="hljs-type">int</span> flag2=<span class="hljs-number">1</span>;<span class="hljs-comment">//为了标志开始计时的flag</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-keyword">if</span>(buttonstate==LOW&amp;&amp;flag1==<span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//如果按下按钮</span><br>   	<span class="hljs-keyword">if</span>(lastbuttonstate==HIGH)&#123;<span class="hljs-comment">//首次按下按钮</span><br>      i=<span class="hljs-number">0</span>;<span class="hljs-comment">//下标更新</span><br>      starttime=millis();<span class="hljs-comment">//起始时间更新</span><br>      flag2=<span class="hljs-number">0</span>;<span class="hljs-comment">//开始计时标志</span><br>      <span class="hljs-built_in">memset</span>(x_x,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(x_x));<br>      <span class="hljs-built_in">memset</span>(y_x,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(y_x));<br>      <span class="hljs-built_in">memset</span>(z_x,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(z_x));<br>      Serial.println(<span class="hljs-string">&quot;首次按下&quot;</span>);<br>    &#125; <br>    x_acc[i]=worldAccX;<span class="hljs-comment">//更新加速度</span><br>    y_acc[i]=worldAccY;<br>    z_acc[i]=worldAccZ;<br>    i++;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span>((millis()-starttime&gt;=<span class="hljs-number">2000</span>||(lastbuttonstate==LOW&amp;&amp;buttonstate==HIGH))&amp;&amp;flag2==<span class="hljs-number">0</span>)&#123;<br>    flag1=<span class="hljs-number">1</span>;<span class="hljs-comment">//关闭记录通道</span><br>    flag2=<span class="hljs-number">1</span>;<span class="hljs-comment">//关闭积分运算通道</span><br>    ...<span class="hljs-comment">//积分运算和模型预测</span><br>    ...<span class="hljs-comment">//串口输出和蓝牙发送等等</span><br>  &#125;<br>  <span class="hljs-keyword">if</span>(buttonstate==HIGH)&#123;flag1=<span class="hljs-number">0</span>;&#125;<span class="hljs-comment">//如果按钮是松开的允许再按记录，如果是按到时间到了结束，不触发flag1变化，不进记录</span><br>  lastbuttonstate=buttonstate;<span class="hljs-comment">//记录上一次按钮状态</span><br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901111002_32.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901111006_33.png" srcset="/img/loading.gif" lazyload></p>
<p>可以实现两种结束记录的方式。</p>
<p>​	其中是每隔50ms记录一次数据，理论上最多40个数据，但是为了避免溢出定义数组长度为50。至于每隔50ms没有在上述代码中体现出来，因为madgwick算法中的参数delta与时间有关，于是另外做了一个计时的变量count顺便计时50ms运行一次，就没有使用delay(50)的方法。</p>
<h3 id="2-4-2-积分环节"><a href="#2-4-2-积分环节" class="headerlink" title="2.4.2 积分环节"></a>2.4.2 积分环节</h3><p>​	对于获得的三个加速度数组，要对其进行两次积分，这时可以将这几个加速度数组看作分段函数，每一段的时间长度都是50ms，对其积分便是求图象上若干个长方形的面积累加，于是积分问题就转变为了对数组求累加和的问题。同时令两次积分的初始值都为0，就得到了坐标系下的相对运动轨迹。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">float</span> <span class="hljs-title function_">sumwhat</span><span class="hljs-params">(<span class="hljs-type">int</span> i,<span class="hljs-type">float</span> tool[<span class="hljs-number">50</span>])</span>&#123;<span class="hljs-comment">//辅助函数求tool数组的前i项和，再乘上时间间隔0.05s</span><br>  <span class="hljs-type">int</span> j;<br>  <span class="hljs-type">float</span> sum=<span class="hljs-number">0.0</span>;<br>  <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>;j&lt;=i;j++)&#123;<br>    sum+=tool[j]*<span class="hljs-number">0.05</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> sum;<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>&#123;<br>    ...<br>    <span class="hljs-comment">//积分环节</span><br>    Serial.println(<span class="hljs-string">&quot;进入积分&quot;</span>);<br>    <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>;k&lt;i;k++)&#123;<br>      x_v[k]=sumwhat(k,x_acc);<br>      y_v[k]=sumwhat(k,y_acc);<br>      z_v[k]=sumwhat(k,z_acc);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>;k&lt;i;k++)&#123;<br>      x_x[k]=sumwhat(k,x_v);<br>      y_x[k]=sumwhat(k,y_v);<br>      z_x[k]=sumwhat(k,z_v);<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果较为准确：</p>
<p><img src="/img/mozhang_img/stitching-collage-1764644244461.jpg" srcset="/img/loading.gif" lazyload alt="上、下">           </p>
<h2 id="2-5-模型训练与部署"><a href="#2-5-模型训练与部署" class="headerlink" title="2.5 模型训练与部署"></a>2.5 模型训练与部署</h2><p>​	到目前为止我们成功将运动轨迹解算成对应的相对位移数组，接下来要对上下左右四种轨迹的分类模型进行训练。</p>
<h3 id="2-5-1-数据集收集"><a href="#2-5-1-数据集收集" class="headerlink" title="2.5.1 数据集收集"></a>2.5.1 数据集收集</h3><p>​	为了模拟真实魔杖挥舞场景，将传感器绑在筷子顶端，按照之前确定的方式固定，挥舞魔杖来采集数据。采集过程中也发现，按照人类的使用习惯，传感器安装在魔杖顶端，手握住末端，人手挥动时基本上只动手腕，因此不会出现纯上下左右平移的情况，而是会在Y轴上自然做出一些移动的，比如向上，人习惯向上移动时向内(-Y方向)挥动；向左，人也习惯向左时向内移动一些，这也证明了我们<strong>忽略Y轴位移只看XOZ平面投影的处理和我们安装传感器的方法是正确的</strong>。</p>
<p>​	每次挥舞完成松开按钮后，将计算出来的三轴位移数据串口打印出来，再通过python的pySerial库读取串口数据并且保存在txt文档中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">...<span class="hljs-comment">//在串口打印时要同时输出开始和结束标志，以方便python脚本判断应该保存的部分</span><br>	Serial.println(<span class="hljs-string">&quot;===START===&quot;</span>);   <span class="hljs-comment">// 一次动作开始</span><br>    <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>;k&lt;i;k++)&#123;<br>      Serial.print(<span class="hljs-string">&quot;x:&quot;</span>);<br>      Serial.print(x_x[k]);<br>      Serial.print(<span class="hljs-string">&quot;,y:&quot;</span>);<br>      Serial.print(y_x[k]);<br>      Serial.print(<span class="hljs-string">&quot;,z:&quot;</span>);<br>      Serial.println(z_x[k]);<br>      &#125;<br>    Serial.println(<span class="hljs-string">&quot;===END===&quot;</span>);     <span class="hljs-comment">// 一次动作结束</span><br>...<br></code></pre></td></tr></table></figure>

<p>mozhang.ipynb （数据收集脚本）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> serial<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><br>SERIAL_PORT = <span class="hljs-string">&quot;COM7&quot;</span><br>BAUD_RATE = <span class="hljs-number">115200</span><br>SAVE_DIR = <span class="hljs-string">r&quot;D:\新建文件夹 (5)\data\RIGHT&quot;</span><span class="hljs-comment">#保存路径</span><br>os.makedirs(SAVE_DIR, exist_ok=<span class="hljs-literal">True</span>)<br><br>ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=<span class="hljs-number">1</span>)<br>time.sleep(<span class="hljs-number">2</span>)<br><br>sample_idx=<span class="hljs-number">1</span><br>recording=<span class="hljs-literal">False</span><br>buffer=[]<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    line = ser.readline().decode(<span class="hljs-string">&quot;utf-8&quot;</span>, errors=<span class="hljs-string">&quot;ignore&quot;</span>).strip()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> line==<span class="hljs-string">&quot;===START===&quot;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;开始采集样本 <span class="hljs-subst">&#123;sample_idx&#125;</span>&quot;</span>)<br>        buffer = []<br>        recording = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> line==<span class="hljs-string">&quot;===END===&quot;</span>:<br>        <span class="hljs-keyword">if</span> recording:<br>            filename = os.path.join(SAVE_DIR, <span class="hljs-string">f&quot;sample_<span class="hljs-subst">&#123;sample_idx:03d&#125;</span>.txt&quot;</span>)<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                f.write(<span class="hljs-string">&quot;\n&quot;</span>.join(buffer))<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;样本 <span class="hljs-subst">&#123;sample_idx&#125;</span> 保存到 <span class="hljs-subst">&#123;filename&#125;</span>&quot;</span>)<br>            sample_idx+=<span class="hljs-number">1</span><br>            recording=<span class="hljs-literal">False</span><br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> recording:<br>        buffer.append(line)<br>        <br> ser.close()<br></code></pre></td></tr></table></figure>

<p>​	最终四个方向各收集到100组数据，依次打包为文件夹。具体样例如下图所示。</p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112242_92.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112244_93.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-5-2-数据预处理"><a href="#2-5-2-数据预处理" class="headerlink" title="2.5.2 数据预处理"></a>2.5.2 数据预处理</h3><p>​	将得到了这些txt文档，用python脚本每个逐行遍历，并用正则表达式取出需要的xz轴的数据，再将其打包为一个2×50的矩阵，每个方向的数据整合成一个100×2×50的大矩阵，获得的四个大矩阵先整合起来再将每个小矩阵展平，最终得到一个400×100的矩阵。然后再定义标签向量，依次为100个1、2、3、4。</p>
<p>mozhang_train.ipynb</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> glob<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_txt</span>(<span class="hljs-params">file_path, max_len=<span class="hljs-number">50</span></span>):<br>    <span class="hljs-comment">#处理单个txt文件，返回一个2x50的矩阵</span><br>    x_vals, z_vals=[],[]<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>            <span class="hljs-keyword">match</span>=re.findall(<span class="hljs-string">r&quot;x:([-+]?\d*\.?\d+),y:([-+]?\d*\.?\d+),z:([-+]?\d*\.?\d+)&quot;</span>, line)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>                x, _, z=<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>]<br>                x_vals.append(<span class="hljs-built_in">float</span>(x))<br>                z_vals.append(<span class="hljs-built_in">float</span>(z))   <br>    <span class="hljs-comment">#不够的补0</span><br>    x_vals=(x_vals+[<span class="hljs-number">0.0</span>]*max_len)[:max_len]<br>    z_vals=(z_vals+[<span class="hljs-number">0.0</span>]*max_len)[:max_len]<br>    <br>    <span class="hljs-keyword">return</span> np.array([x_vals, z_vals])<br><span class="hljs-comment"># 批量读取文件</span><br>files_1=glob.glob(<span class="hljs-string">r&quot;D:\新建文件夹 (5)\data\1_UP\*.txt&quot;</span>)<br>files_2=glob.glob(<span class="hljs-string">r&quot;D:\新建文件夹 (5)\data\2_DOWN\*.txt&quot;</span>)<br>files_3=glob.glob(<span class="hljs-string">r&quot;D:\新建文件夹 (5)\data\3_LEFT\*.txt&quot;</span>)<br>files_4=glob.glob(<span class="hljs-string">r&quot;D:\新建文件夹 (5)\data\4_RIGHT\*.txt&quot;</span>)<br><br>matrices_1=[process_txt(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files_1]<br>matrices_2=[process_txt(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files_2]<br>matrices_3=[process_txt(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files_3]<br>matrices_4=[process_txt(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files_4]<br><span class="hljs-comment">#堆叠成三维数组 100×2×50</span><br>data_1=np.stack(matrices_1)<br>data_2=np.stack(matrices_2)<br>data_3=np.stack(matrices_3)<br>data_4=np.stack(matrices_4)<br><span class="hljs-comment">#整合</span><br>X=np.concatenate([data_1,data_2,data_3,data_4],axis=<span class="hljs-number">0</span>)<br>y=np.array([<span class="hljs-number">1</span>]*<span class="hljs-number">100</span>+[<span class="hljs-number">2</span>]*<span class="hljs-number">100</span>+[<span class="hljs-number">3</span>]*<span class="hljs-number">100</span>+[<span class="hljs-number">4</span>]*<span class="hljs-number">100</span>)<br><span class="hljs-comment">#展平</span><br>X=X.reshape(X.shape[<span class="hljs-number">0</span>],-<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112340_95.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-5-3-模型训练"><a href="#2-5-3-模型训练" class="headerlink" title="2.5.3 模型训练"></a>2.5.3 模型训练</h3><p>​	接下来我们将数据集按照7：3比例分为训练集和验证集，用支持向量机SVM训练模型，得到了准确率为0.942的模型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br><span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVC<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> classification_report, accuracy_score<br><span class="hljs-comment">#划分训练集和测试集</span><br>X_train, X_test, y_train, y_test = train_test_split(<br>    X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">41</span>, stratify=y<br>)<br><span class="hljs-comment">#用SVM训练</span><br>clf = SVC(kernel=<span class="hljs-string">&#x27;rbf&#x27;</span>, C=<span class="hljs-number">1</span>, gamma=<span class="hljs-number">1.0</span>)<span class="hljs-comment">#此处gamma参数决定rgb核的宽度，经尝试1.0时效果最好，转c语言的时候gamma需要为定值</span><br>clf.fit(X_train, y_train)<br><span class="hljs-comment">#预测</span><br>y_pred = clf.predict(X_test)<br><span class="hljs-comment">#评估</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;准确率:&quot;</span>, accuracy_score(y_test, y_pred))<br><span class="hljs-built_in">print</span>(classification_report(y_test, y_pred))<br></code></pre></td></tr></table></figure>

<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112401_96.png" srcset="/img/loading.gif" lazyload></p>
<p>以下为将所有数据经模型运行一遍后得到的预测结果，几乎是能够完全分类正确的。</p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112404_97.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-5-4-模型部署"><a href="#2-5-4-模型部署" class="headerlink" title="2.5.4 模型部署"></a>2.5.4 模型部署</h3><p>​	目前只在python中训练出了模型，我们需要将其部署到esp32上，使其不依赖于电脑便可以运行模型实现轨迹分类。</p>
<p>​	需要用到上位机吗？并不需要，因为：</p>
<p>​		1.上下左右轨迹特征度高</p>
<p>​		2.数据量下，仅400个</p>
<p>​		3.用的是机器学习的SVM算法，比较简单</p>
<p>​	因此说明我们得到的模型相对简单，可能esp32自带的算力便可以支持。</p>
<p>​	一个模型本身可以看作是一个包含矩阵运算的复杂数学函数，只要我们能够将模型的数学形式表示出来，便可以用c语言的形式写出来，但是这种模型的参数一般都非常多而且复杂，于是我们选择使用micromlgen库，其支持将简单的python模型导出为c语言形式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> micromlgen <span class="hljs-keyword">import</span> port<br>c_code=port(clf)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&quot;D:\新建文件夹 (5)\data\classifier.h&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(c_code)<br></code></pre></td></tr></table></figure>

<p>用micromlgen库成功导出模型的c语言版本后，得到的结果为：（仅为部分代码，原函数见 mozhang\classifier.h）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdarg&gt;</span></span><br>namespace Eloquent &#123;<br>    namespace ML &#123;<br>        namespace Port &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SVM</span> &#123;</span><br>                public:<br>                    <span class="hljs-comment">/**</span><br><span class="hljs-comment">                    * Predict class for features vector</span><br><span class="hljs-comment">                    */</span><br>                    <span class="hljs-type">int</span> <span class="hljs-title function_">predict</span><span class="hljs-params">(<span class="hljs-type">float</span> *x)</span> &#123;<br>                        <span class="hljs-type">float</span> kernels[<span class="hljs-number">131</span>] = &#123; <span class="hljs-number">0</span> &#125;;<br>                        <span class="hljs-type">float</span> decisions[<span class="hljs-number">6</span>] = &#123; <span class="hljs-number">0</span> &#125;;<br>                        <span class="hljs-type">int</span> votes[<span class="hljs-number">4</span>] = &#123; <span class="hljs-number">0</span> &#125;;<br>                        kernels[<span class="hljs-number">0</span>] = compute_kernel(x,   <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">-0.0</span>  , <span class="hljs-number">-0.0</span>  , <span class="hljs-number">0.1</span>  , <span class="hljs-number">0.18</span>  , <span class="hljs-number">0.19</span>  , <span class="hljs-number">0.19</span>  , <span class="hljs-number">0.19</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">-0.0</span>  , <span class="hljs-number">-0.0</span>  , <span class="hljs-number">0.03</span>  , <span class="hljs-number">0.14</span>  , <span class="hljs-number">0.27</span>  , <span class="hljs-number">0.31</span>  , <span class="hljs-number">0.33</span>  , <span class="hljs-number">0.33</span>  , <span class="hljs-number">0.34</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span>  , <span class="hljs-number">0.0</span> );<br>                        ...<br>                        decisions[<span class="hljs-number">0</span>] = <span class="hljs-number">-0.206241160743</span><br>                        + kernels[<span class="hljs-number">0</span>] * <span class="hljs-number">0.06523232929</span><br>                        + kernels[<span class="hljs-number">6</span>] * <span class="hljs-number">0.60241767888</span><br>                        + kernels[<span class="hljs-number">7</span>] * <span class="hljs-number">0.239027242719</span><br>                        + kernels[<span class="hljs-number">8</span>] * <span class="hljs-number">0.452574668479</span><br>                        + kernels[<span class="hljs-number">9</span>] * <span class="hljs-number">0.31387810585</span><br>                        + kernels[<span class="hljs-number">11</span>]<br>                        + kernels[<span class="hljs-number">15</span>] * <span class="hljs-number">0.786632371654</span><br>                        + kernels[<span class="hljs-number">17</span>] * <span class="hljs-number">0.353397278291</span><br>                        + kernels[<span class="hljs-number">18</span>]<br>                        + kernels[<span class="hljs-number">19</span>] * <span class="hljs-number">0.162507380842</span><br>                        + kernels[<span class="hljs-number">20</span>] * <span class="hljs-number">0.252686093615</span><br>                        ...<br>                    &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>而mozhang.ino的改动如下：导入了clf模型，添加了存放输入输出的变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">...<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;classifier.h&quot;</span></span><br>Eloquent::ML::Port::SVM clf;<span class="hljs-comment">//实例化模型</span><br>...<br><span class="hljs-type">float</span> input[<span class="hljs-number">100</span>]=&#123;<span class="hljs-number">0</span>&#125;;<span class="hljs-comment">//用于跑模型的变量</span><br><span class="hljs-type">int</span> pred;<span class="hljs-comment">//预测结果</span><br>...<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>&#123;<br>    ...<br>    <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">50</span>;k++)&#123;<br>          input[k]=x_x[k];<br>          input[k+<span class="hljs-number">50</span>]=z_x[k];<br>        &#125;<br>    ...<br>    pred=clf.predict(input);<br>    Serial.println(pred);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​	经上电测试，发现上下左右的标签对应变成了0、1、2、3，但是仍然实现了轨迹分类，并且模型运行速度非常快，松开按钮后零延迟输出预测结果，说明esp32的算力是充足的。</p>
<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112453_102.png" srcset="/img/loading.gif" lazyload></p>
<p>​	这同时也定义了一个工作流，如果要添加新的轨迹的话，只需要按照数据收集、模型训练、模型部署的顺序更新一遍即可。</p>
<h2 id="2-6-蓝牙传输"><a href="#2-6-蓝牙传输" class="headerlink" title="2.6 蓝牙传输"></a>2.6 蓝牙传输</h2><p>​	esp32自带蓝牙模块，可以直接用库函数调用。</p>
<p>​	其中魔杖的开发板作为主机，小车的开发板作为从机。依次定义名称为”ESP32_BT”和”vehicle”，但是并不能用名称连接，而是要用从机的mac地址连接，连接再用SerialBT.print()便可实现蓝牙通信。同时为了直观观察蓝牙是否连接成功，定义了一个LED灯来指示，成功连接就闪烁三下，失败就一直亮。</p>
<p>主机mozhang.ino</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;BluetoothSerial.h&quot;</span></span><br>...<br>BluetoothSerial SerialBT;<span class="hljs-comment">//定义</span><br>...<br><span class="hljs-type">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span>&#123;<br>  ...<br>  SerialBT.begin(<span class="hljs-string">&quot;ESP32_BT&quot;</span>,<span class="hljs-literal">true</span>);<br>  <span class="hljs-type">uint8_t</span> macAddr[<span class="hljs-number">6</span>]=&#123;<span class="hljs-number">0x84</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0x4E</span>&#125;;<br><br>  <span class="hljs-keyword">if</span> (SerialBT.connect(macAddr)) &#123;<br>    Serial.println(<span class="hljs-string">&quot;Connected to Slave!&quot;</span>);<br>    <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">3</span>;k++) &#123;<span class="hljs-comment">//蓝牙连接成功提升:灯闪三下</span><br>      digitalWrite(LED_PIN, HIGH);<br>      delay(<span class="hljs-number">300</span>);<br>      digitalWrite(LED_PIN, LOW);<br>      delay(<span class="hljs-number">300</span>);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    Serial.println(<span class="hljs-string">&quot;Failed to connect to Slave.&quot;</span>);<br>    digitalWrite(LED_PIN, HIGH);<span class="hljs-comment">//蓝牙连接失败提示:灯一直亮</span><br>  &#125;<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span>&#123;<br>    ...<br>	SerialBT.println(pred);<span class="hljs-comment">//发送</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>从机vehicle.ino</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;BluetoothSerial.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_bt_device.h&quot;</span></span><br><br>BluetoothSerial SerialBT;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> &#123;<br>  Serial.begin(<span class="hljs-number">115200</span>);<br>  SerialBT.begin(<span class="hljs-string">&quot;vehicle&quot;</span>);  <span class="hljs-comment">//从机名称</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* mac = esp_bt_dev_get_address();<br>  Serial.<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ESP32 Bluetooth MAC address: %02X:%02X:%02X:%02X:%02X:%02X\n&quot;</span>,<br>                mac[<span class="hljs-number">0</span>], mac[<span class="hljs-number">1</span>], mac[<span class="hljs-number">2</span>], mac[<span class="hljs-number">3</span>], mac[<span class="hljs-number">4</span>], mac[<span class="hljs-number">5</span>]);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (SerialBT.available()) &#123;<br>      <span class="hljs-type">char</span> msg = SerialBT.read();<br>      <span class="hljs-comment">//用msg控制小车</span><br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/mozhang_img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250901112650_111.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="三、小车part"><a href="#三、小车part" class="headerlink" title="三、小车part"></a>三、小车part</h1><h2 id="3-1-硬件"><a href="#3-1-硬件" class="headerlink" title="3.1 硬件"></a>3.1 硬件</h2><p>​	小车所用的硬件有TB6612稳压板和带光电编码器的直流电机，以及控制他们的esp32开发板。</p>
<p>​	在TB6612稳压板上，其对电机的控制通过七个管脚：STBY、PWMA&#x2F;PWMB、AIN1&#x2F;AIN2、BIN1&#x2F;BIN2。其中PWM控制速度，IN1&#x2F;IN2控制方向，只有STBY高电平时才会激活控制。</p>
<p>​	编码器的相关管脚为E1A&#x2F;E1B，E2A&#x2F;E2B，依次表示左右轮的A相和B相，A相用来判断速度，用固定时间内的脉冲数来换算；B相用来判断方向，通过B相相对于A相是超前还是落后来判断。本来用的是双轮平衡小车，想要通过调节PID来使其直立平衡和运动平衡，但是控制需要得到双轮转速来进行反馈调节，每转脉冲数600，轮径4.5cm，轮距10cm都已经测出。但是右轮电机的光电编码器是坏的，不能准确测出脉冲数，因此不能测出速度，不能实现双轮平衡。</p>
<p>​	于是我们采取添加拓展版加牛眼轮的方法使小车能够平衡。</p>
<p>​	管脚连接为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PWMA 12  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AIN1 14</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AIN2 27</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PWMB 13  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIN1 33</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIN2 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STBY 26  </span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENCODER_L   19   <span class="hljs-comment">//左轮A相</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DIRECTION_L 22   <span class="hljs-comment">//左轮B相</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENCODER_R   18   <span class="hljs-comment">//右轮A相</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DIRECTION_R 23   <span class="hljs-comment">//右轮B相</span></span><br></code></pre></td></tr></table></figure>

<p><img src="/img/mozhang_img/stitching-collage-1764644572720.jpg" srcset="/img/loading.gif" lazyload></p>
<h2 id="3-2-控制逻辑"><a href="#3-2-控制逻辑" class="headerlink" title="3.2 控制逻辑"></a>3.2 控制逻辑</h2><p>​	因为测速有问题，并不能实现过于精确的逻辑控制，于是仅仅做了简单的控制逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> <br>&#123;<br>  <br>  <span class="hljs-keyword">if</span> (SerialBT.available()) &#123;<br>    msg = SerialBT.read();<br>    Serial.println(msg);<br>    <span class="hljs-keyword">if</span>(msg==<span class="hljs-string">&#x27;0&#x27;</span>)&#123;<span class="hljs-comment">//前进</span><br>      SetPWM(<span class="hljs-number">1</span>, <span class="hljs-number">70</span>);<br>      SetPWM(<span class="hljs-number">2</span>, <span class="hljs-number">70</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(msg==<span class="hljs-string">&#x27;1&#x27;</span>)&#123;<span class="hljs-comment">//停止</span><br>        SetPWM(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>        SetPWM(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(msg==<span class="hljs-string">&#x27;2&#x27;</span>)&#123;<span class="hljs-comment">//左转</span><br>      SetPWM(<span class="hljs-number">1</span>,<span class="hljs-number">40</span>);<br>      SetPWM(<span class="hljs-number">2</span>,<span class="hljs-number">70</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(msg==<span class="hljs-string">&#x27;3&#x27;</span>)&#123;<span class="hljs-comment">//右转</span><br>      SetPWM(<span class="hljs-number">1</span>,<span class="hljs-number">70</span>);<br>      SetPWM(<span class="hljs-number">2</span>,<span class="hljs-number">40</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​	如果测速功能正常，可以按照当前状态是否静止，或者当前是前进还是后退，用if-else和switch-case语句来实现更多样的控制。</p>
<p><img src="/img/mozhang_img/ScreenShot_2025-12-02_110409_690.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>本篇写于2025.12.2，嵌高已经出分一个半月了，但是我的五百块钱报销还没下来，不愧是控院。回顾这个项目，虽然是小组作业，但是还是全程全部是我C完的😒(虽然也没花多少时间，8.23开始，9.3结束)。第一次从0开始搭建一个项目，虽然逻辑很简单，但是最后跑起来的适合还是很高兴，这个项目最难的还是驯服那个三轴加速度，我中期答辩就卡在那里了，那时候还天天科二练车，这边还死活做不出来，我严重怀疑商家给我的传感器是残次品。第二个就是搞懂坐标系的定义，真忘不了那个下午，拿着根筷子在书桌前挥舞，最后用一堆实验数据归纳出了结论，然后碰巧又是正确的，神了。从那个时候茅塞顿开，后面训练部署什么的都一口气完成。</p>
<p>所有代码均已经上传github</p>
<p><a target="_blank" rel="noopener" href="https://github.com/DKESTXD/qiangao-mozhang">https://github.com/DKESTXD/qiangao-mozhang</a></p>
<p>里面有演示视频和制作日志，挺好玩的还</p>
<h3 id="可改进之处"><a href="#可改进之处" class="headerlink" title="可改进之处"></a>可改进之处</h3><ul>
<li>世界坐标系定义问题。前文中说到世界坐标系在上电瞬间就确定下来了，因此在使用魔杖时只能始终面朝上电方向，或者说这时左右变成了一个绝对的定义而不是相对人身体的定义，比如如果上电后转身180°再使用的话，左右轨迹的判断就反过来了</li>
<li>小车的平衡问题。因为右轮电机的编码器问题，没能实现优雅的双轮平衡小车，而是加了辅助轮。</li>
<li>模型还可以再改，可以将y轴考虑进去，用3D轨迹，用更大更复杂的模型训练，使得轨迹判断更精确，甚至能够解决世界坐标系定义导致的使用魔杖时转身导致不准的问题。</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>做一根“魔杖”——记2025嵌高项目</div>
      <div>https://dkestxd.github.io/2025/12/02/做一根“魔杖”——记2025嵌高项目/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Li Fengke</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/04/%E7%94%A8%E6%8E%92%E9%98%9F%E8%AE%BA%E6%A8%A1%E6%8B%9F%E5%88%86%E6%9E%90%E9%A3%9F%E5%A0%82%E6%8E%92%E9%98%9F%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E4%BB%BF%E7%9C%9F/" title="用排队论模拟分析食堂排队问题以及仿真">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">用排队论模拟分析食堂排队问题以及仿真</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/03/hello-world/" title="Hello World">
                        <span class="hidden-mobile">Hello World</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
